<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 5</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(1000, 750, Phaser.AUTO, 'phaser-example', { preload: preload, create: create, update: update });
    
function preload() {
    game.load.image('phaser', 'assets/sgt animaltalker.png');
    game.load.image('bullet', 'assets/acorn1.png');
    game.load.spritesheet('squirrels', 'assets/evilSquirrel.png', 60, 60);
    game.load.image('sky', 'assets/background.png');
    game.load.image('ground', 'assets/ground.png');
    game.load.image('tree', 'assets/tree.png');
    game.load.image('cup', 'assets/cometdoes.png');
    game.load.image('titlescreen', 'assets/TitleBG.png');
}

var sprite;
var bullets;
var squirrels;
var totalSquirrels = 10;
var cursors;
var cups

var bulletTime = 0;
var bullet;
    
var score = 0;
var scoreText;
var total = 0;
var timer = 0;
var stateText;
var endText
    
var gameover;
var overmessage;
var countdown;
    
var startBG;
var startPrompt;

function create() {
    game.physics.startSystem(Phaser.Physics.ARCADE);
    game.physics.arcade.gravity.y = 0;

    game.add.image(0, 0, 'sky');
    game.add.image(0,650, 'ground');
    game.add.image(0, 120, 'tree');
    
    scoreText = game.add.text(16, 300, 'score: 0', { fontSize: '32px', fill: 'red'});
    
    endText = game.add.text(game.world.centerX,game.world.centerY,' ', { font: '84px Arial', fill: '#fff' });
    endText.anchor.setTo(0.5, 0.5);
    endText.visible = false;

    //cups = game.add.sprite(game.world.randomX, 600, 'cup');
    //game.physics.enable(cups);
    //cups.enableBody = true;
    //cups.body.collideWorldBounds = true;
    
    cups = game.add.group();
    cups.enableBody = true;
    cups.physicsBodyType = Phaser.Physics.ARCADE;
    game.physics.enable(cups, Phaser.Physics.ARCADE);

    for (var i = 0; i < 10; i++) {
        var d = cups.create(game.world.randomX, 600, 'cup', game.rnd.integerInRange(0, 3));
        d.name = 'cup' + i;
        d.body.immovable = false;
        d.body.velocity.y = 0;
    }
 
    //  This will check Group vs. Group collision (bullets vs. squirrels!)

    squirrels = game.add.group();
    squirrels.enableBody = true;
    squirrels.physicsBodyType = Phaser.Physics.ARCADE;
    game.physics.enable(squirrels, Phaser.Physics.ARCADE);
    
    game.time.events.repeat(Phaser.Timer.SECOND * 6, 10, createSquirrels, this);
    
    bullets = game.add.group();
    bullets.enableBody = true;
    bullets.physicsBodyType = Phaser.Physics.ARCADE;

    for (var i = 0; i < 20; i++) {
        var b = bullets.create(0, 0, 'bullet');
        b.name = 'bullet' + i;
        b.exists = false;
        b.visible = false;
        b.checkWorldBounds = true;
        b.events.onOutOfBounds.add(resetBullet, this);
    }

    sprite = game.add.sprite(400, 470,'phaser');
    game.physics.enable(sprite, Phaser.Physics.ARCADE);
    sprite.body.allowRotation = false;
    sprite.body.immovable = true;
    
    cursors = game.input.keyboard.createCursorKeys();
    game.input.keyboard.addKeyCapture([ Phaser.Keyboard.SPACEBAR ]);

    // gameover message
    gameover = false;
    countdown = game.add.text(10, 10, 'Squirrels Left ' + totalSquirrels, {fontSize: '20px', fill: 'red'});
    
//    // start screen
//    game.state.add('StartMenu', StartMenu);
//    startBG = game.add.image(0, 0, 'titlescreen');
//    startBG.inputEnabled = true;
//    startBG.events.onInputDown.addOnce(startGame, this);
//    startPrompt = game.add.text(game.world.centerX, game.world.centerY, 'Touch to Start!', {fontSize: '30', fill: 'yellow'})
//    startPrompt.anchor.x = Math.round(startPrompt.width * 0.5) / startPrompt.width;
}

function update() {
    //  As we don't need to exchange any velocities or motion we can the 'overlap' check instead of 'collide'
    game.physics.arcade.overlap(bullets, squirrels, collisionHandler, null, this);
    
    game.physics.arcade.overlap(cups, squirrels, cupCollision, null, this);
    
    //sprite.rotation += 0.01;
    //sprite.rotation = game.physics.arcade.angleToPointer(sprite);
    
    if (game.input.activePointer.isDown){
        fireBullet();
    }
    
    if (cups.countLiving()== 0 ){
        endText.text = " Game Over, \n thanks for playing, \n you did really well!!!!!!!!!";
        endText.visible = true;
        squirrels.removeAll();
    }
}
    

function fireBullet () {
    if (game.time.now > bulletTime) {
        bullet = bullets.getFirstExists(false);

        if (bullet) {
            bullet.reset(sprite.x + 3, sprite.y + 20);
            bullet.body.velocity.y = -300;
            bulletTime = game.time.now + 150;
            game.physics.arcade.moveToPointer(bullet, 350); 
        }
    }
}

//  Called if the bullet goes out of the screen
function resetBullet (bullet) {
    bullet.kill();
}

//  Called if the bullet hits one of the squirrel sprites
function collisionHandler (bullet, squirrel) {
    bullet.kill();
    squirrel.kill();
    score += 10;
    scoreText.text = 'Score:' + score;
    totalSquirrels--;
    checkSquirrelsLeft();
}
    
function cupCollision (cup, squirrel) {
    cup.kill();
    squirrel.kill();
    score -= 5;
    scoreText.text = 'Score:' + score;
    totalSquirrels--;
    checkSqurrelsLeft();
}
    
function checkSquirrelsLeft() {
    if (totalSquirrels <= 0) {
        gameover = true;
        countdown.setText('Squirrels Left 0');
        overmessage = game.add.text(game.world.centerX, game.world.centerY, 'GAME OVER', {fontSize: '42', fill: 'red'});
        overmessage.anchor.x = Math.round(overmessage.width * 0.5) / overmessage.width;  
        overmessage.inputEnabled = true;
        overmessage.events.onInputDown.addOnce(quitGame, this);
    }
    else {
         countdown.setText('Squirrels Left ' + totalSquirrels);
    }
}
    
//function startGame(pointer) {
//    alert("HERE");
//    game.state.start('squirrelpacification');
//}
//
//function quitGame(pointer) {
//    game.state.start('StartMenu');
//}
    
function createSquirrels(){    
    for (var i = 0; i < totalSquirrels; i++)  {
        var c = squirrels.create(game.world.randomX, 0, 'squirrels', game.rnd.integerInRange(0, 36));
        c.name = 'veg' + i;
        c.body.immovable = false;
        c.body.velocity.y = game.rnd.integerInRange(50, 150);   
    };
}
</script>

</body>
</html>