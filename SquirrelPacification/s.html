<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <title>Squirrel Pacification</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(1000, 750, Phaser.AUTO, '', {preload: preload, create: create, update: update });

function preload() {
    game.load.image('background', 'assets/background.png');
    game.load.image('dude', 'assets/sgt animaltalker.png');
    game.load.image('tree', 'assets/tree.png');
    game.load.image('cup', 'assets/cometdoes.png');
    game.load.image('ground', 'assets/ground.png');
    game.load.image('squirrel', 'assets/evilSquirrel.png');
    game.load.image('acorn', 'assets/acorn1.png');
    game.load.image('arm', 'assets/arm.png');
}

var player;
var cursors;
var bullets;
var fireRate = 100;
var nextFire = 3;
var star;
var squirrel;
var squirrels;
var squirrelGang;
var totalSquirrels;

function create() {
    game.physics.startSystem(Phaser.Physics.ARCADE);
    game.physics.arcade.gravity.y=0
    game.add.image(0, 0, 'background');
    game.add.image(0, 650, 'ground');
    game.add.image(0, 110, 'tree');
    game.add.image(400, 600, 'cup');
    totalSquirrels = 2;
}

function buildSquirrels() {
//     for (var i=0; i < totalSquirrels; i++) {
//        var squirrels = game.add.sprite(game.world.randomX, game.world.randomY, 'squirrel');
//        game.physics.enable(squirrels, Phaser.Physics.ARCADE);
//        squirrels.enableBody = true;
//        squirrels.physicsBodyType = Phaser.Physics.ARCADE;
//        squirrels.physicsBodyType.immovable = true;
//        squirrels.body.collideWorldBounds = true;
//        squirrels.body.customSeparateX = true;
//        squirrels.body.customSeparateY = true;
//        squirrelGang = game.add.group();
//    }
    squirrelGang = this.add.group(); // create a new group called bunny group
    squirrelGang.enableBody = true; // enableBody allows bunnies to interact with other objects we create
    for(var i=0; i<totalSquirrels; i++) { // builds individual bunnies and adds to group
        var s = squirrelGang.create(this.rnd.integerInRange(-10, this.world.width-50), this.rnd.integerInRange(this.world.height-180, this.world.height-60), 'squirrel');
        s.anchor.setTo(0.5, 0.5); // anchor point of bunny to itself
        s.body.moves = false;
        s.animations.add('Rest', this.game.math.numberArray(1,58)); // animations
        s.animations.add('Walk', this.game.math.numberArray(68,107)); // animations
        s.animations.play('Rest', 24, true);
        assignSquirrelMovement(s); // makes bunny moving right away
    }
}
    
function assignSquirrelMovement(s) {
    sposition = Math.floor(this.rnd.realInRange(50, this.world.width-50)); // position that bunny wants to go to / 50 pixels left and right of screen
    sdelay = this.rnd.integerInRange(2000, 6000); // bunnies start moving at different times b/w 2 and 6 seconds
    if(sposition < s.x){ // b.scale.x = 1 or -1 flips bunny from one direction to another
        s.scale.x = 1;
    }
    else{
        s.scale.x = -1;
    }
    // tween = actual mvt for each bunny
    t = this.add.tween(s).to({x:sposition}, 3500, Phaser.Easing.Quadratic.InOut, true, sdelay); //properties, duration, ease, autoStart, delay
    t.onStart.add(this.startSquirrel, this);
    t.onComplete.add(this.stopSquirrel, this);
}
    
function startSquirrel(s) {
    s.animations.stop('Rest'); // stop our play animation
    s.animations.play('Walk', 24, true); // 24 frames per second / autoloop
}

function stopSquirrel(s) {
    s.animations.stop('Walk');
    s.animations.play('Rest', 24, true);
    this.assignSquirrelMovement(s); // pass bunny to assignBunnyMovement and start process for each bunny
}

function buildBullets() {
    bullets = game.add.group();
    bullets.enableBody = true;
    bullets.physicsBodyType = Phaser.Physics.ARCADE;
    bullets.createMultiple(100, 'acorn');
    bullets.setAll('checkWorldBounds', true);
    bullets.setAll('outOfBoundsKill', true);
} 

function makePlayer() {
    player = game.add.sprite(600, 600, 'dude');
    player.anchor.set(0.5);
    player.body.collideWorldBounds = true;
    player.body.immovable = false;
    player.body.allowRotation = false;
    star = game.add.image(300, 300, 'cup');
    star.enableBody = true;
    star.physicsBodyType = Phaser.Physics.ARCADE;     
}
    
function update() {
    if (game.input.activePointer.isDown){
        fire();
    }

    game.physics.arcade.overlap(bullets, squirrels, collisionHandler, null, this);      // if bombs overlap with player then call bombHitsPlayer function
}

function fire() {
    if (game.time.now > nextFire && bullets.countDead() > 0 && totalSquirrels > 0)
    {
        nextFire = game.time.now + fireRate;
        var bullet = bullets.getFirstDead();
        bullet.reset(player.x - 100, player.y - 65);
        game.physics.arcade.moveToPointer(bullet, 350);
    }
}

function render() {
    game.debug.text('Active Bullets: ' + bullets.countLiving() + ' / ' + bullets.total, 32, 32);
    game.debug.spriteInfo(player, 32, 450);
    game.debug.spriteInfo(star, 32, 450);
}

function processHandler (bullets, squirrels) {
    return true;
}

function collisionHandler (s, bullets) {
    if (s.exists) {
        s.kill();
        totalSquirrels--;
    }
}

</script>

</body>
</html>
